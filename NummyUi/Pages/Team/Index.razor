@namespace NummyUi.Pages.Team
@page "/team"
@using AntDesign.Select.Internal
@using NummyShared.DTOs

<Spin Spinning="@_teamsLoading">
    <div @onclick="@(() => _isAddTeamModalVisible = true)">
        <Card Bordered Hoverable Style="margin-bottom: 24px; cursor: pointer;">
            <CardMeta>
                <AvatarTemplate>
                    <Avatar Shape="AvatarShape.Square"
                            Size="@("3.5rem")"
                            Style="color: #52c41a; background-color: #f6ffed; vertical-align: middle; border-radius: 4px">
                        <Icon Type="plus" Theme="@IconThemeType.Outline"/>
                    </Avatar>
                </AvatarTemplate>
                <TitleTemplate>Create Team</TitleTemplate>
                <DescriptionTemplate>
                    <Text Type="TextElementType.Secondary">Click to create a new team</Text>
                </DescriptionTemplate>
            </CardMeta>
        </Card>
    </div>
    <AntList TItem="TeamToListDto" Class="filterCardList" Grid="_listGridType" DataSource="_teams">
        <ListItem NoFlex>
            <Card Bordered Hoverable BodyStyle="padding-bottom: 20px;" Actions="@GetActions(context)">
                <CardMeta>
                    <AvatarTemplate>
                        <Avatar Shape="AvatarShape.Square"
                                Size="@("3.5rem")"
                                Style="color: #f56a00; background-color: #fde3cf; vertical-align: middle; border-radius: 4px">
                            @context.Name[0].ToString().ToUpper()
                        </Avatar>
                    </AvatarTemplate>
                    <TitleTemplate>@context.Name</TitleTemplate>
                    <DescriptionTemplate>
                        <Text Type="TextElementType.Secondary">@context.Description</Text>
                    </DescriptionTemplate>
                </CardMeta>
                <Divider/>
                <GridRow>
                    <GridCol Span="11">
                        <GridRow Style="margin-bottom: 12px">
                            <Text Strong>Members</Text>
                        </GridRow>
                        <GridRow Style="margin-bottom: 28px">
                            <AvatarGroup MaxCount="2" MaxStyle="color: #f56a00; background-color:#fde3cf;">
                                @foreach (var user in context.Users)
                                {
                                    <Tooltip Title="@($"{user.Name} {user.Surname}")" Placement="Placement.Top">
                                        <Unbound Context="avatarContext">
                                            <Avatar Style="@($"background-color: {user.AvatarColorHex};")"
                                                    RefBack="@avatarContext">
                                                @(user.Name[0].ToString().ToUpper() + user.Surname[0].ToString().ToUpper())
                                            </Avatar>
                                        </Unbound>
                                    </Tooltip>
                                }
                            </AvatarGroup>
                        </GridRow>
                    </GridCol>
                    <GridCol Span="2">
                        <Divider Type="DirectionVHType.Vertical" Style="height: 100%"/>
                    </GridCol>
                    <GridCol Span="11">
                        <GridRow Style="margin-bottom: 12px">
                            <Text Strong>Applications</Text>
                        </GridRow>
                        <GridRow Style="margin-bottom: 28px">
                            <AvatarGroup MaxCount="2" MaxStyle="color: #f56a00; background-color:#fde3cf;">
                                <Avatar Src="https://zos.alipayobjects.com/rmsportal/ODTLcjxAfvqbxHnVXCYX.png"/>
                                <Avatar Style="background-color: #f56a00">K</Avatar>
                                <Tooltip Title="Ant User" Placement="Placement.Top">
                                    <Avatar Style="background-color: #87d068;" Icon="user"/> @*RefBack="@context"*@
                                </Tooltip>
                                <Avatar Style="background-color: #1890ff;" Icon="ant-design"/>
                            </AvatarGroup>
                        </GridRow>
                    </GridCol>
                </GridRow>

                <GridRow Style="margin-bottom: 6px">
                    <Text Strong>Created at</Text>
                </GridRow>
                <GridRow Style="margin-bottom: 0">
                    @context.CreatedAt.ToString("dd MMMM, yyyy")
                </GridRow>
            </Card>
        </ListItem>
    </AntList>
</Spin>

<Modal @bind-Visible="_isAddTeamModalVisible"
       Title="Create New Team"
       OnOk="@HandleAddTeam"
       OnCancel="@(() => _isAddTeamModalVisible = false)">
    <Form @ref="@_addTeamForm" Model="@_teamAddModel" Layout="vertical">
        <FormItem Label="Team Name" Required>
            <Input @bind-Value="@_teamAddModel.Name" Placeholder="Enter team name"/>
        </FormItem>
        <FormItem Label="Description">
            <TextArea @bind-Value="@_teamAddModel.Description" Placeholder="Enter team description"></TextArea>
        </FormItem>
        <FormItem Label="Team Members">
            <Select Mode="Multiple"
                    Placeholder="Select team members"
                    @bind-Values="@_teamAddModel.SelectedUserIds"
                    TItemValue="Guid"
                    TItem="Guid"
                    Style="width: 100%"
                    EnableSearch
                    Loading="@_allUsersLoading"
                    AllowClear>
                <SelectOptions>
                    @foreach (var user in _allUsers)
                    {
                        <SelectOption TItemValue="Guid"
                                      TItem="Guid"
                                      Value=@user.Id
                                      Label="@($"{user.Name} {user.Surname}")"/>
                    }
                </SelectOptions>
            </Select>
        </FormItem>
        @if (_teamAddModel.SelectedUserIds.Any())
        {
            <FormItem>
                @*<AntDesign.Flex Wrap="FlexWrap.Wrap" Gap="FlexGap.Small">*@
                @foreach (var userId in _teamAddModel.SelectedUserIds)
                {
                    var user = _allUsers.First(u => u.Id == userId);

                    <Tag Closable Style="padding: 6px 10px; margin-top: 6px;"
                         OnClose="@(() => RemoveUser(userId))">
                        <Avatar Size="@("1.7rem")"
                                Style="@($"background-color: {user.AvatarColorHex}; margin-right: 8px;")">
                            @($"{user.Name[0]}{user.Surname[0]}".ToUpper())
                        </Avatar>
                        <Text Strong Style="font-size: 13px">@($"{user.Name} {user.Surname}")</Text>
                    </Tag>
                }
                @*</AntDesign.Flex>*@
            </FormItem>
        }
        <FormItem Label="Team Applications">
            <Select Mode="Multiple"
                    Placeholder="Select team applications"
                    @bind-Values="@_teamAddModel.SelectedApplicationIds"
                    TItemValue="Guid"
                    TItem="Guid"
                    Style="width: 100%"
                    EnableSearch
                    Loading="@_allApplicationsLoading"
                    AllowClear>
                <SelectOptions>
                    @foreach (var application in _allApplications)
                    {
                        <SelectOption TItemValue="Guid"
                                      TItem="Guid"
                                      Value=@application.Id
                                      Label="@application.Name"/>
                    }
                </SelectOptions>
            </Select>
        </FormItem>
        @if (_teamAddModel.SelectedApplicationIds.Any())
        {
            <FormItem>
                @foreach (var applicationId in _teamAddModel.SelectedApplicationIds)
                {
                    var application = _allApplications.First(a => a.Id == applicationId);

                    <Tag Closable Style="padding: 6px 10px; margin-top: 6px;"
                         OnClose="@(() => RemoveApplication(applicationId))">
                        <Avatar Size="@("1.7rem")"
                                Style="@($"background-color: {application.AvatarColorHex}; margin-right: 8px;")">
                            @(application.Name[0].ToString().ToUpper())
                        </Avatar>
                        <Text Strong Style="font-size: 13px">@application.Name</Text>
                    </Tag>
                }
            </FormItem>
        }
    </Form>
</Modal>

@code
{
    private RenderFragment<TeamToListDto> Edit => ctx => @<AntDesign.Tooltip Title="Edit">
                                                             <Icon Type="edit" Theme="@IconThemeType.Outline"
                                                                   OnClick="@(() => OnEdit(ctx))"/>
                                                         </AntDesign.Tooltip>;

    private RenderFragment<TeamToListDto> Share => ctx => @<AntDesign.Tooltip Title="Share">
                                                              <Icon Type="share-alt" Theme="@IconThemeType.Outline"
                                                                    OnClick="@(() => OnShare(ctx))"/>
                                                          </AntDesign.Tooltip>;

    private RenderFragment<TeamToListDto> Delete => ctx => @<AntDesign.Tooltip Title="Delete">
                                                               <Popconfirm Title="Are you sure delete this team?"
                                                                           OkText="Yes"
                                                                           CancelText="No"
                                                                           OnConfirm="@(() => OnDelete(ctx))">
                                                                   <Icon Type="delete" Style="color: red"
                                                                         Theme="@IconThemeType.Outline"/>
                                                               </Popconfirm>
                                                           </AntDesign.Tooltip>;

    private RenderFragment<TeamToListDto> More => ctx => @<AntDesign.Tooltip Title="More">
                                                             <Icon Type="more" Theme="@IconThemeType.Outline"
                                                                   OnClick="@(() => { })"/>
                                                         </AntDesign.Tooltip>;

    private IList<RenderFragment> GetActions(TeamToListDto context)
    {
        return new List<RenderFragment>
        {
            Edit(context),
            Share(context),
            Delete(context),
            More(context)
        };
    }
}